# Google Maps APIキー発行とHTTPリファラ制限設定

## 1. 前提条件

- Google Cloud プロジェクトが作成済みで、請求アカウントとリンクされていること。
- Maps JavaScript API / Places API など必要なAPIが有効化されていること。
- キーを発行するユーザーがプロジェクトのオーナーまたは同等の権限を持つ。

## 2. APIキーの発行手順

1. <https://console.cloud.google.com/> にアクセスし、対象プロジェクトを選択。
2. ナビゲーションメニューから **「API とサービス」→「認証情報」** を開く。
3. **「認証情報を作成」** → **「APIキー」** を選択すると、新しいキーが生成される。
4. 表示されたキーはすぐにコピーして安全な場所に保管し、**「キーを制限」** をクリックして制限設定へ進む。

## 3. HTTPリファラ制限の設定

1. 「アプリケーションの制限」で **「HTTPリファラ (ウェブサイト)」** を選択。
2. 利用するドメインをワイルドカード形式で追加する。
   - 本番ドメイン例: `https://example.com/*`
   - 開発用ローカル: `http://localhost/*` または `http://127.0.0.1/*`
3. APIキーを複数ドメインで使用する場合は、それぞれのURLパターンを追加。
4. 保存するとリファラ制限が有効化され、指定ドメイン以外からのリクエストが拒否される。

## 4. API制限の設定

1. 「APIの制限」で **「キーを制限」** を選択。
2. 利用するAPI（例: Maps JavaScript API、Places API、Geolocation API など）にチェックを入れる。
3. 不要なAPIを割り当てないことで、誤用や課金リスクを軽減。

## 5. セキュリティ運用

- APIキーは `.env` やクラウドのシークレットマネージャで管理し、リポジトリにコミットしない。
- 誤って漏洩した場合は、コンソールの「キーの再生成」で即座にローテーション。旧キーは無効化する。
- CLIやサーバーサイドで利用するキーは IP アドレス制限を設定し、HTTPリファラ制限のキーとは分離して管理。
- 利用状況を **「API とサービス」→「ダッシュボード」** で定期的に確認し、不審なリクエストがないかチェック。

## 6. トラブルシューティング

| 症状                           | 対処                                                                                  |
| ------------------------------ | ------------------------------------------------------------------------------------- |
| `RefererNotAllowedMapError`    | リファラURLが正しく登録されているか確認。末尾のスラッシュやサブドメインの違いに注意。 |
| `ApiNotActivatedMapError`      | 対象APIが有効化されているか確認。API制限で該当APIが許可されているかチェック。         |
| リクエスト数が想定より多い     | キャッシュ戦略を見直し、必要であればクォータ制限やアラートを設定。                    |
| 開発中にリファラ制限で弾かれる | `http://localhost:*` を追加するか、開発用に別キーを発行。                             |
